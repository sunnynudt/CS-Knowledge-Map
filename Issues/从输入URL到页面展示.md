# 从输入 URL 到页面展示，这中间发生了什么？

<!--
浏览器输入 url 到页面的展现，具体发生了些什么可以展开说下么
断于上述题目知识点。第二个问题笔者通常喜欢问一些考察可深可浅的一些题目，注入：浏览器输入 url 到页面的展现，具体发生了些什么可以展开说下么

基本回答都是

在浏览器地址栏输入URL
浏览器解析URL获取协议，主机，端口，path
浏览器组装一个HTTP（GET）请求报文
浏览器获取主机ip地址
打开一个socket与目标IP地址，端口建立TCP链
TCP链接建立后发送HTTP请求
服务器将响应报文通过TCP连接发送回浏览器，浏览器接收HTTP响应
根据资源类型决定如何处理（假设资源为HTML文档）
解析HTML文档，构件DOM树，下载资源，构造CSSOM树，执行js脚本
最后展现出来给用户
基本如果应聘者只回到了上述步骤，很多关键步骤（前端应该了解的知识点）没有提及，那么基本凉凉一半了。这里简述下笔者感觉，这其中你应该具体展开说明的。

浏览器发送请求，是否需要查看缓存？是否请求资源在缓存中并且新鲜，跳转到转码步骤？如果资源已经缓存，是否新鲜？如何检查？怎么判断、http1.0 和 http1.1 的区别是什么，这些字段的优先级是怎么样子的。
浏览器解析 url 获取协议，过程是什么？DNS 递归查询可否介绍下？
建立 TCP 链接的三次握手是否可以介绍下
服务器接受到请求，是否需要检查缓存？检查什么字段？什么样的缓存会需要服务端检查？
服务端发送 TCP 链接，浏览器接受 http 相应后，根据什么来决定是否需要关闭连接？关闭 TCP 的四次挥手是什么？
浏览器是否需要检查状态码，有哪些状态码？（笔者高频考码：304、200）
在解析的时候，具体如何解析、是否有顺序。（重绘重排高频考题就在这里）
总结如上、我们是否可以给出一些基本的网站优化手段？？？
上述题目的每一步展开，都将会是下一个面试题。

具体的知识点介绍，不是此文主要讲解内容，这里就不多言了。
-->

这道题目涉及到了网络、操作系统、Web 等一系列知识，下图是一个完整的流程示意图。

![](/Images/从输入URL到页面展示完整流程示意图.png)

如图，整个流程需要各个进程间的配合，分为两个步骤：导航流程和渲染流程。

## 1. 导航流程：用户发出 URL 请求到页面开始解析的过程

首先了解浏览器进程、渲染进程、网络进程的主要职责：

- 浏览器进程：主要负责用户交互、子进程管理和文件存储等功能。

- 网络进程：主要负责面向渲染进程和浏览器进程等提供网络下载功能。

- 渲染进程：主要职责是把从网络下载的 HTML、CSS、JS、图片等资源解析为可以显示和交互的页面。在 Chrome 中，渲染进程运行在安全沙箱里。

### 1 用户输入

如果搜索内容，地址栏会使用默认的搜索引擎，合成新的带搜索关键字的 URL。如果输入内容符合 URL 规则，地址栏会根据规则加上协议等，合成完整的 URL。

### 2. URL 请求过程

*浏览器进程*通过*进程间通信*（IPC）把 URL 请求发送至网络进程，*网络进程*接收后，发起 URL 请求流程。

1. 首先，网络进程每次发起请求时，都会先在浏览器缓存中查询该请求结果和缓存标识。

   - 浏览器缓存机制：根据是否需要向服务器重新发起 HTTP 请求，将缓存结果分为：强制缓存（本地缓存）和协商缓存。

     - 强制缓存：向浏览器缓存查找缓存结果和缓存标识，并根据该结果的缓存规则来决定是否使用该缓存的过程。

       - 分类

         - 不存在该缓存结果和缓存标识，强制缓存失败，则向服务器再发送一次请求。

         - 存在请求结果和缓存标识，但该结果已失效过期，强制缓存失败，则使用协商缓存。

         - 存在请求结果和缓存标识，而且结果未过期，强制缓存生效，直接返回结果。

       - 规则

         - `Expires(HTTP/1.0)`

         - `Cache-Control(HTTP/1.1): public, private(默认), no-cache, no-store, max-age`

     - 协商缓存：强制缓存失效后，浏览器携带缓存标识向服务器发起请求，由服务器根据缓存标识决定是否继续使用缓存的过程。

       - 分类

         - 协商缓存生效，返回 304。

         - 协商缓存失效，返回 200 和请求结果。

       - 字段：`Last-Modified/If-Modified-Since`，`Etag/If-None-Match`

     - 浏览器缓存机制流程图

       ![](/Images/浏览器缓存机制流程图.png)

2. 网络请求流程

   - DNS 域名解析：获取请求域名的服务器 IP 地址。

     - DNS 服务器递归查询、迭代查询

       - 递归查询：客户端到本地服务器

       - 迭代查询：DNS 服务器之间的交互

       - DNS 域名解析流程图

         ![](/Images/DNS域名解析流程图.png)

   - TCP/IP: 利用 IP 和服务器建立 TCP 连接。

     - 建立连接：是为了在客户端和服务端维护连接，而建立一定的数据结构来维护双方交互的状态，用这样的数据结构来保证所谓的面向连接的特性。

     - TCP 三次握手

       - TCP 特点：顺序问题、丢包问题、连接维护、流量控制（针对另一个端）、拥塞控制（针对网络）。

       - 状态位：SYN 是发起一个连接，ACK 是回复，RST 是重新连接，FIN 是结束连接。

       - 三次握手除了双方建立连接外，主要还是为了沟通一件事情，就是 TCP 包的序号的问题。

         - 每个连接都要有不同的序号，这个序号的起始序号是随着时间变化的，可以看成一个 32 位的计数器，每 4 微秒 加一，如果计算一下，如果到重复，需要 4 个多小时，那个绕路的包早就死翘翘了，因为 IP 包头里有个 TTL，即生存时间。

       - 三次握手时序图：一开始，客户端和服务端都处于`CLOSE`状态。先是服务端主动监听某个端口，处于`LISTEN`状态。然后客户端主动发起连接`SYN`，之后处于`SYN-SENT`状态。服务端收到发起的连接后，返回`SYN`，并且`ACK`客户端的`SYN`，之后处于`SYN-RCVD`状态。客户端收到服务端发送的`SYN`和`ACK`之后，发送`ACK`的`ACK`，之后处于`ESTABLISHED`状态，因为它的一收一发成功了。服务端收到`ACK`的`ACK`之后，处于`ESTABLISHED`状态，因为它也一收一发了。

         ![](/Images/TCP三次握手状态时序图.png)

     - TCP 四次挥手

       ![](/Images/TCP四次挥手状态时序图.jpg)

     - TCP 状态机：图中加粗加黑的部分是上述主要流程，其中阿拉伯数字的序号是连接过程中的顺序，大写中文数字的序号是连接断开过程中的顺序，加粗的实线是客户端 A 的状态变迁，加粗的虚线是服务端 B 的状态变迁。

       ![](/Images/TCP状态机.jpg)

   - HTTP/HTTPS: 建立 TCP 连接后，浏览器端会构建请求行、请求头等信息，并把和该域名相关的 Cookie 等数据附加到请求头中，然后向服务器发送构建的请求信息。

     - HTTPS 工作模式

     ![](/Images/HTTPS工作模式.jpg)

   - 服务器接收请求信息后，生成响应数据，并发给网络进程。网络进程接收到并解析响应头信息。

     - 重定向：如果返回的状态码是 301 或 302，网络进程会从响应头的`Location`字段读取重定向的地址，重新发起 HTTP（HTTPS）请求，一切从头开始。

     - `HSTS`(HTTP 严格传输协议，HTTP Strict Transport Security)

       - HTTPS 服务器可以在响应头里添加一个`Strict-Transport-Security`字段，再设置一个有效期 A，告诉浏览器本网站只能使用 HTTPS，在 A 时间内都不允许使用 HTTP。

       - 浏览器如果再访问同样域名，就会自动把 URL 里的 HTTP 改成 HTTPS 直接访问网站，减少了一次跳转，加快了连接速度，也避免了“中间人攻击”。这样，浏览器只会在第一次连接使用 HTTP，之后都会走 HTTPS。

     - 响应类型数据处理：`Content-type`字段，如果字段值为`octet-stream`等值被浏览器判断为*下载类型*，那么该请求就会被提交给浏览器的*下载管理器*，同时该 URL 的导航流程就此结束。如果字段值为`HTML`等，浏览器继续进行导航流程。

### 3. 准备渲染进程

打开一个新页面采用的渲染进程策略（以 Chrome）为例：

- 通常情况下，打开新的页面都会使用一个单独的渲染进程。

- 如果是从 A 页面打开 B 页面，且 A 和 B 都属于同一站点，那么 B 页面会复用 A 页面的渲染进程；如果是其他情况，浏览器进程则会为 B 创建一个新的渲染进程。

- 渲染进程准备好后，此时的文档数据还在网络进程中，并没有提交给渲染进程。

### 4. 提交文档

*文档*是指 URL 请求的响应体数据。

- “提交文档”的消息由浏览器进程发出，渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”。

- 等文档数据传输完成后，渲染进程会返回“确认提交”的消息给浏览器进程。

- 浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，并更新 Web 页面。

### 5. 渲染阶段

一旦文档被提交，渲染进程便开始页面解析和子资源加载。一旦页面生成完成，渲染进程会发送一个消息给浏览器进程，浏览器接收到消息后，会停止标签图标上的加载动画。

## 2. 渲染流程

## 3. 参考文献

- [知乎 饿了么前端：浏览器输入 URL 后发生了什么？](https://zhuanlan.zhihu.com/p/43369093)

- [一文读懂一个 URL 请求的过程是怎样的](https://juejin.im/post/5b83b0bfe51d4538c63131a8)

- [Github: 当···时发生了什么？](https://github.com/skyline75489/what-happens-when-zh_CN)

- [Github: 从浏览器输入一个 url 到页面渲染，涉及的知识点及优化点](https://github.com/sunyongjian/blog/issues/34)

- [前端经典面试题: 从输入 URL 到页面加载发生了什么？](https://segmentfault.com/a/1190000006879700)
