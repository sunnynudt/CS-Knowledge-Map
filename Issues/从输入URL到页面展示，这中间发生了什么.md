# 从输入 URL 到页面展示，这中间发生了什么？

<!--
浏览器输入 url 到页面的展现，具体发生了些什么可以展开说下么
断于上述题目知识点。第二个问题笔者通常喜欢问一些考察可深可浅的一些题目，注入：浏览器输入 url 到页面的展现，具体发生了些什么可以展开说下么

基本回答都是

在浏览器地址栏输入URL
浏览器解析URL获取协议，主机，端口，path
浏览器组装一个HTTP（GET）请求报文
浏览器获取主机ip地址
打开一个socket与目标IP地址，端口建立TCP链
TCP链接建立后发送HTTP请求
服务器将响应报文通过TCP连接发送回浏览器，浏览器接收HTTP响应
根据资源类型决定如何处理（假设资源为HTML文档）
解析HTML文档，构件DOM树，下载资源，构造CSSOM树，执行js脚本
最后展现出来给用户
基本如果应聘者只回到了上述步骤，很多关键步骤（前端应该了解的知识点）没有提及，那么基本凉凉一半了。这里简述下笔者感觉，这其中你应该具体展开说明的。

浏览器发送请求，是否需要查看缓存？是否请求资源在缓存中并且新鲜，跳转到转码步骤？如果资源已经缓存，是否新鲜？如何检查？怎么判断、http1.0 和 http1.1 的区别是什么，这些字段的优先级是怎么样子的。
浏览器解析 url 获取协议，过程是什么？DNS 递归查询可否介绍下？
建立 TCP 链接的三次握手是否可以介绍下
服务器接受到请求，是否需要检查缓存？检查什么字段？什么样的缓存会需要服务端检查？
服务端发送 TCP 链接，浏览器接受 http 相应后，根据什么来决定是否需要关闭连接？关闭 TCP 的四次挥手是什么？
浏览器是否需要检查状态码，有哪些状态码？（笔者高频考码：304、200）
在解析的时候，具体如何解析、是否有顺序。（重绘重排高频考题就在这里）
总结如上、我们是否可以给出一些基本的网站优化手段？？？
上述题目的每一步展开，都将会是下一个面试题。

具体的知识点介绍，不是此文主要讲解内容，这里就不多言了。
-->

这道题目涉及到了网络、操作系统、Web 等一系列知识，下图就是一个完整的流程示意图。

![](/Images/从输入URL到页面展示完整流程示意图.png)

如图所示，整个流程需要各个进程之间的配合，主要可以分为两个步骤：导航流程和渲染流程。

## 1. 导航流程：用户发出 URL 请求到页面开始解析的过程

首先，理性的认识一下浏览器进程、渲染进程、网络进程的主要职责。

- 浏览器进程：主要负责用户交互、子进程管理和文件存储等功能。
- 网络进程：主要负责面向渲染进程和浏览器进程等提供网络下载功能。
- 渲染进程：主要职责就是把从网络下载的 HTML、CSS、JS、图片等资源解析为可以显示和交互的页面。在 Chrome 中，渲染进程运行在安全沙箱里。

### 1 用户输入

如果搜索内容，地址栏会使用默认的搜索引擎，合成新的带搜索关键字的 URL。如果输入内容符合 URL 规则，地址栏会根据规则，加上协议等，合成完整的 URL。

### 2. URL 请求过程

*浏览器进程*会通过*进程间通信（IPC）*把 URL 请求发送至网络进程，*网络进程*接收到 URL 后，会在这里发起 URL 请求流程。

1. 首先，网络进程会查找是否有*本地缓存*，如果有缓存资源，直接返回资源给浏览器进程。

2. 如果没有查找到缓存，就直接进入网络请求流程。

   - DNS 解析，获取请求域名的服务器 IP 地址。

     - DNS 域名解析

     - DNS 服务器递归查询、迭代查询

       - 递归查询：客户端到本地服务器

       - 迭代查询：DNS 服务器之间的交互

   - 利用 IP 和服务器建立 TCP 连接。

     - 三次握手

     - 四次挥手

   - 建立 TCP 连接后，浏览器端会构建请求行、请求头等信息，并把和该域名相关的 Cookie 等数据附加到请求头中，然后向服务器发送构建的请求信息。

   - 服务器接收请求信息后，生成响应数据，并发给网络进程。网络进程接收到并解析响应头信息。

     - 重定向：如果返回的状态码是 301 或 302，网络进程会从响应头的`Location`字段读取重定向的地址，重新发起 HTTP（HTTPS）请求，一切从头开始。

     - 如果状态码是 200，表示成功。

     - 响应类型数据处理：`Content-type`字段，如果字段值为`octet-stream`等值被浏览器判断为*下载类型*，那么该请求就会被提交给浏览器的*下载管理器*，同时该 URL 的导航流程就此结束。如果字段值为`HTML`等，浏览器继续进行导航流程。

### 3. 准备渲染进程

打开一个新页面采用的渲染进程策略（以 Chrome）为例：

- 通常情况下，打开新的页面都会使用一个单独的渲染进程。

- 如果是从 A 页面打开 B 页面，且 A 和 B 都属于同一站点，那么 B 页面会复用 A 页面的渲染进程；如果是其他情况，浏览器进程则会为 B 创建一个新的渲染进程。

- 渲染进程准备好后，此时的文档数据还在网络进程中，并没有提交给渲染进程。

### 4. 提交文档

*文档*是指 URL 请求的响应体数据。

- “提交文档”的消息由浏览器进程发出，渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”。

- 等文档数据传输完成后，渲染进程会返回“确认提交”的消息给浏览器进程。

- 浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，并更新 Web 页面。

### 5. 渲染阶段

一旦文档被提交，渲染进程便开始页面解析和子资源加载。一旦页面生成完成，渲染进程会发送一个消息给浏览器进程，浏览器接收到消息后，会停止标签图标上的加载动画。

## 2. 渲染流程

## 3. 参考文献

- [知乎 饿了么前端：浏览器输入 URL 后发生了什么？](https://zhuanlan.zhihu.com/p/43369093)

- [一文读懂一个 URL 请求的过程是怎样的](https://juejin.im/post/5b83b0bfe51d4538c63131a8)

- [Github: 当···时发生了什么？](https://github.com/skyline75489/what-happens-when-zh_CN)

- [Github: 从浏览器输入一个 url 到页面渲染，涉及的知识点及优化点](https://github.com/sunyongjian/blog/issues/34)

- [前端经典面试题: 从输入 URL 到页面加载发生了什么？](https://segmentfault.com/a/1190000006879700)

- [彻底理解浏览器的缓存机制](https://heyingye.github.io/2018/04/16/%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/)

- [FEX: 从输入 URL 到页面加载完成的过程中都发生了什么事情？](http://fex.baidu.com/blog/2014/05/what-happen/)
